# API: Trades (сделки)

---

# 1. Агрегированные сделки (временной ряд цен)

## Описание

Эндпоинт `GET /api/trades/aggregated` возвращает биржевые сделки в формате **1 запись = 1 реальная сделка**. Предназначен для построения временных рядов цен по инструментам.

### Особенность данных в БД

В таблице `Trades` каждая биржевая сделка хранится **двумя строками**:
- строка покупателя (`Operation` = "Купля")
- строка продавца (`Operation` = "Продажа")

Обе строки имеют одинаковый `TradeNum`, `ClassCode`, `TradeDate`, а также одинаковые `Price`, `Qty` и `Value`. Эндпоинт объединяет их в одну запись.

---

## Запрос

```
GET /api/trades/aggregated
```

### Query-параметры (все опциональны)

| Параметр | Тип | Описание |
|----------|-----|----------|
| `ClassCode` | string | Фильтр по коду класса/рынка (например, TQBR, SPBFUT) |
| `SecCode` | string | Фильтр по коду бумаги (работает, если в таблице есть колонка SecCode) |
| `from` | string | Начало диапазона дат (ISO 8601 или timestamp) |
| `to` | string | Конец диапазона дат (ISO 8601 или timestamp) |
| `limit` | integer | Ограничение количества записей. По умолчанию: 10000, максимум: 100000 |

---

## Ответ

### Успешный ответ (200 OK)

Массив объектов, отсортированный по `TradeDateTime` по возрастанию.

| Поле | Тип | Описание |
|------|-----|----------|
| `ClassCode` | string | Код класса/рынка |
| `SecCode` | string | Код бумаги (из колонки SecCode, если есть; иначе = ClassCode) |
| `Price` | number | Цена сделки |
| `Qty` | number | Количество |
| `Value` | number | Сумма сделки (Price × Qty или значение из БД) |
| `TradeDateTime` | string | Дата и время сделки (ISO 8601) |

### Пример ответа

```json
[
  {
    "ClassCode": "TQBR",
    "SecCode": "GAZP",
    "Price": 250.5,
    "Qty": 100,
    "Value": 25050,
    "TradeDateTime": "2025-02-18T10:30:00.000Z"
  },
  {
    "ClassCode": "TQBR",
    "SecCode": "SBER",
    "Price": 285.2,
    "Qty": 50,
    "Value": 14260,
    "TradeDateTime": "2025-02-18T10:31:15.000Z"
  }
]
```

---

## Примеры запросов

```bash
# Все сделки (до 10000 записей)
GET /api/trades/aggregated

# По классу инструментов
GET /api/trades/aggregated?ClassCode=TQBR

# По конкретной бумаге
GET /api/trades/aggregated?SecCode=GAZP

# Диапазон дат
GET /api/trades/aggregated?from=2025-02-01&to=2025-02-18

# Ограничение выборки
GET /api/trades/aggregated?limit=5000

# Комбинация параметров
GET /api/trades/aggregated?ClassCode=TQBR&SecCode=GAZP&from=2025-02-01&to=2025-02-18&limit=1000
```

---

## Ошибки

### 400 Bad Request — отсутствуют колонки

Если в таблице `Trades` нет обязательных колонок:

```json
{
  "error": "Не найдены обязательные колонки в таблице Trades",
  "missing": ["TradeNum", "Price"]
}
```

**Ожидаемые колонки** (допустимы варианты имён с учётом регистра):
- `TradeNum` — номер сделки
- `ClassCode` — код инструмента
- `TradeDate` — дата/время сделки
- `Price` — цена
- `Qty` — количество

Опционально: `Value` (сумма), `SecCode` (код бумаги).

### 500 Internal Server Error

Ошибка сервера или базы данных.

---

## Правила агрегации

1. **Группировка**: по `(TradeNum, ClassCode, TradeDate)`
2. **Value**: если в БД есть колонка `Value` — используется она; иначе вычисляется как `Price × Qty`
3. **SecCode**: если в БД есть колонка `SecCode` — возвращается она; иначе используется `ClassCode`

---

# 2. Список SecCode

## Описание

Эндпоинт `GET /api/trades/sec-codes` возвращает **массив уникальных значений SecCode** из таблицы `Trades`. Удобен для получения списка инструментов, по которым есть сделки (например, для выпадающего списка или фильтров).

## Запрос

```
GET /api/trades/sec-codes
```

Параметры не требуются.

## Ответ

### Успешный ответ (200 OK)

Массив строк — уникальные SecCode, отсортированные по возрастанию.

```json
["GAZP", "LKOH", "SBER"]
```

Если в таблице нет колонки `SecCode`, используются уникальные значения `ClassCode`.

## Ошибки

- **400** — нет колонок `ClassCode` или `SecCode` в таблице Trades
- **500** — ошибка сервера

---

## Swagger

Эндпоинты Trades описаны в Swagger UI: `http://<host>:<port>/api-docs` (раздел Trades).
